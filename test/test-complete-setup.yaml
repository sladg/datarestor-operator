# Filebrowser deployment for viewing backup files
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backup-filebrowser
  labels:
    app: backup-filebrowser
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backup-filebrowser
  template:
    metadata:
      labels:
        app: backup-filebrowser
    spec:
      containers:
        - name: filebrowser
          image: filebrowser/filebrowser:latest
          ports:
            - containerPort: 8080
          env:
            - name: FB_BASEURL
              value: "/"
            - name: FB_PORT
              value: "8080"
            - name: FB_AUTH_METHOD
              value: "noauth"
            - name: FB_DATABASE
              value: "/srv/database.db"
            - name: FB_LOG
              value: "stdout"
            - name: FB_LOG_LEVEL
              value: "INFO"
          volumeMounts:
            - name: backup-storage
              mountPath: /srv
      volumes:
        - name: backup-storage
          persistentVolumeClaim:
            claimName: backup-storage-pvc
---
# Service for Filebrowser
apiVersion: v1
kind: Service
metadata:
  name: backup-filebrowser
  labels:
    app: backup-filebrowser
spec:
  type: NodePort
  ports:
    - port: 8080
      targetPort: 8080
  selector:
    app: backup-filebrowser
---
# Storage PVC for backup data
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-storage-pvc
  labels:
    app: backup-storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: openebs-hostpath
---
# Combined Backup Configuration with Multiple Targets
apiVersion: backup.autorestore-backup-operator.com/v1alpha1
kind: PVCBackup
metadata:
  name: test-combined-backup
spec:
  pvcSelector:
    labelSelector:
      matchLabels:
        app: backup-storage
    namespaces: [default]

  backupTargets:
    - name: local-backup
      priority: 1
      restic:
        repository: "local:/tmp/local-restic-repo"
        password: "test-password"
        tags: [test, local, primary]
      retention:
        maxSnapshots: 10
        maxAge: "168h" # 7 days

    - name: remote-nfs-primary
      priority: 1
      restic:
        repository: "local:/mnt/backup/_OPERATOR_TEST"
        password: "test-password"
        tags: [test, nfs, primary, remote]
      nfs:
        server: "10.0.2.1"
        path: "/volume2/Documents"
        mountPath: "/mnt/backup"
        mountOptions:
          - hard
          - nfsvers=4.1
      retention:
        maxSnapshots: 10
        maxAge: "168h" # 7 days

    # - name: s3-secondary
    #   priority: 2
    #   restic:
    #     repository: "s3:s3.amazonaws.com/backup-bucket"
    #     password: "test-password"
    #     tags: [test, s3, secondary, cloud]
    #     env:
    #       - name: AWS_ACCESS_KEY_ID
    #         value: "test-access-key"
    #       - name: AWS_SECRET_ACCESS_KEY
    #         value: "test-secret-key"
    #       - name: AWS_DEFAULT_REGION
    #         value: "us-west-2"
    #     flags: ["--verbose", "--compression", "auto"]
    #   retention:
    #     maxSnapshots: 30
    #     maxAge: "720h" # 30 days

  schedule:
    cron: "*/10 * * * *" # Every 10 minutes
    waitForHealthy: true
    stopPods: false

  autoRestore: true
